name: Tests

on:
  pull_request

jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.2

      - name: Test
        run: go test -exec sudo -v ./...

  fc-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.2

      - name: Setup kvm
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup firecracker
        run: |
          sudo mv fc/firecracker_jun10 /usr/bin/firecracker
          chmod 777 /usr/bin/firecracker
          sudo mv fc/jailer_jun10 /usr/bin/jailer
          chmod 777 /usr/bin/jailer

      - name: Grab some blueprints
        run: |
          mkdir out
          mkdir out/blueprint
          cd out/blueprint
          wget -q https://github.com/loopholelabs/drafter/releases/latest/download/oci-valkey-x86_64.tar.zst
          wget -q https://github.com/loopholelabs/drafter/releases/latest/download/drafteros-oci-x86_64.tar.zst
          tar --zstd -xf oci-valkey-x86_64.tar.zst
          tar --zstd -xf drafteros-oci-x86_64.tar.zst
          mv oci oci.ext4
          mv kernel vmlinux
          mv disk rootfs.ext4
          rm *.zst

      - name: Build agent
        run: |
          cd cmd/drafter-agent
          go build .
          cd ../..
          mkdir tmproot
          sudo mount out/blueprint/rootfs.ext4 tmproot
          sudo mv cmd/drafter-agent/drafter-agent tmproot/usr/bin/drafter-agent
          sudo umount out/blueprint/rootfs.ext4
          rmdir tmproot

      - name: Test
        run: go test -exec sudo -v ./pkg/runtimes/firecracker/. --tags integration --timeout 120m

  tests-migration-basic:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.2

      - name: Setup kvm
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup firecracker
        run: |
          sudo mv fc/firecracker_jun10 /usr/bin/firecracker
          chmod 777 /usr/bin/firecracker
          sudo mv fc/jailer_jun10 /usr/bin/jailer
          chmod 777 /usr/bin/jailer

      - name: Grab some blueprints
        run: |
          mkdir out
          mkdir out/blueprint
          cd out/blueprint
          wget -q https://github.com/loopholelabs/drafter/releases/latest/download/oci-valkey-x86_64.tar.zst
          wget -q https://github.com/loopholelabs/drafter/releases/latest/download/drafteros-oci-x86_64.tar.zst
          tar --zstd -xf oci-valkey-x86_64.tar.zst
          tar --zstd -xf drafteros-oci-x86_64.tar.zst
          mv oci oci.ext4
          mv kernel vmlinux
          mv disk rootfs.ext4
          rm *.zst

      - name: Build agent
        run: |
          cd cmd/drafter-agent
          go build .
          cd ../..
          mkdir tmproot
          sudo mount out/blueprint/rootfs.ext4 tmproot
          sudo mv cmd/drafter-agent/drafter-agent tmproot/usr/bin/drafter-agent
          sudo umount out/blueprint/rootfs.ext4
          rmdir tmproot

      - name: Disable swap
        run: |
          sudo swapoff -a
          cat /proc/swaps

      - name: Test
        run: go test -exec sudo -v ./pkg/runtimes/firecracker/. --tags "integration migration" --timeout 120m --run ^TestMigrationBasic

  tests-migration-adv:
    runs-on: ubuntu-latest
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: 1.24.2

      - name: Setup kvm
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup firecracker
        run: |
          sudo mv fc/firecracker_jun10 /usr/bin/firecracker
          chmod 777 /usr/bin/firecracker
          sudo mv fc/jailer_jun10 /usr/bin/jailer
          chmod 777 /usr/bin/jailer

      - name: Grab some blueprints
        run: |
          mkdir out
          mkdir out/blueprint
          cd out/blueprint
          wget -q https://github.com/loopholelabs/drafter/releases/latest/download/oci-valkey-x86_64.tar.zst
          wget -q https://github.com/loopholelabs/drafter/releases/latest/download/drafteros-oci-x86_64.tar.zst
          tar --zstd -xf oci-valkey-x86_64.tar.zst
          tar --zstd -xf drafteros-oci-x86_64.tar.zst
          mv oci oci.ext4
          mv kernel vmlinux
          mv disk rootfs.ext4
          rm *.zst

      - name: Build agent
        run: |
          cd cmd/drafter-agent
          go build .
          cd ../..
          mkdir tmproot
          sudo mount out/blueprint/rootfs.ext4 tmproot
          sudo mv cmd/drafter-agent/drafter-agent tmproot/usr/bin/drafter-agent
          sudo umount out/blueprint/rootfs.ext4
          rmdir tmproot

      - name: Disable swap
        run: |
          sudo swapoff -a
          cat /proc/swaps

      - name: Test
        run: go test -exec sudo -v ./pkg/runtimes/firecracker/. --tags "integration migration" --timeout 120m --run ^TestMigrationAdv
